!function(a){"use strict";function b(a,b,c){c=c||{},"undefined"==typeof c.fetchStubs&&(c.fetchStubs=!1),c.api||(c.api=new n(q.apiUrlBase));var d,e=encodeURIComponent(q.appSelf.origin);d=c.fetchStubs?"/payments/stub-in-app-products/"+a.toString()+"/":"/payments/"+e+"/in-app/"+a.toString()+"/",q.log.info("fetching product info at URL",d,"fetching stubs?",c.fetchStubs),c.api.get(d,function(c,d){return c?(q.log.error("Error fetching product info",c),b(c,{productId:a})):void b(null,m(d))})}function c(a,b){var c={};if("string"!=typeof a)return q.log.error("unexpected receipt type:",typeof a),b("INVALID_RECEIPT",c);var d=a.split("~");if(1===d.length)c=d[0];else{if(2!==d.length)return q.log.error("wrong number of tilde separated segments in receipt"),b("INVALID_RECEIPT",c);c=d[1]}var e=c.split(".");if(3!==e.length)return q.log.error("wrong number of JWT segments in receipt:",e.length),b("INVALID_RECEIPT",c);c=e[1];try{c=f(c)}catch(g){return q.log.error("error base64 decoding receipt:",g.name,g.message),b("INVALID_RECEIPT",c)}try{c=JSON.parse(c)}catch(g){return q.log.error("error parsing receipt JSON:",g.name,g.message),b("INVALID_RECEIPT",c)}return b(null,c)}function d(a,b){var c={};if(!a.product)return q.log.error("receipt is missing the product field"),b("INVALID_RECEIPT",c);if(!a.product.url)return q.log.error("receipt is missing product.url"),b("INVALID_RECEIPT",c);if(!a.product.storedata)return q.log.error("receipt is missing product.storedata"),b("INVALID_RECEIPT",c);if("string"!=typeof a.product.storedata)return q.log.error("unexpected storedata in receipt:",a.product.storedata),b("INVALID_RECEIPT",c);var d={};if(a.product.storedata.split("&").forEach(function(a){var b=a.split("=");d[b[0]]=decodeURIComponent(b[1])}),c.productId=d.inapp_id,!c.productId)return q.log.error("Could not find productId in storedata:",a.product.storedata),b("INVALID_RECEIPT",c);var e=a.product.url;e&&!e.match(/^(http(s)?|app):\/\/.*$/g)&&(e="app://"+e),c.productUrl=e;var f="test-receipt"===a.typ;if(f&&!q.fakeProducts)return q.log.error("cannot restore test receipts when fakeProducts is false"),b("TEST_RECEIPT_NOT_ALLOWED",c);var g=q.fakeProducts&&f;return q.allowAnyAppReceipt||g||e===q.appSelf.origin?void b(null,c):(q.log.error("app origin",q.appSelf.origin,"does not match receipt product URL",e),b("INVALID_RECEIPT",c))}function e(a,b){for(var c=!1,d=a.verify||"",e=0;e<q.receiptCheckSites.length;e++){var f=q.receiptCheckSites[e];if(0===d.indexOf(f)){c=!0;break}}return c?void b(null,a):(q.log.error("Receipt check URL",a.verify,"is not whitelisted. Valid choices:",q.receiptCheckSites),b("INVALID_RECEIPT",a))}function f(a){switch(a=a.replace(/-/g,"+"),a=a.replace(/_/g,"/"),a.length%4){case 0:break;case 1:a+="===";break;case 2:a+="==";break;case 3:a+="=";break;default:throw"Illegal base64url string!"}return atob(a)}function g(a,b,c){c=c||{},c.maxTries=c.maxTries||void 0,c.pollIntervalMs=c.pollIntervalMs||void 0;var d={productId:a},e=q.log,f=new n(q.apiUrlBase);e.debug("starting purchase for product",a);var g="/webpay/inapp/prepare/";f.post(g,{inapp:a},function(a,g){if(a)return b(a);e.debug("xhr load: JSON",g);var i=q.mozPay([g.webpayJWT]);i.onerror=function(){e.error("mozPay: received onerror():",this.error.name),b(this.error.name,d)},i.onsuccess=function(){e.debug("mozPay: received onsuccess()"),l(f,f.url(g.contribStatusURL,{versioned:!1}),function(a,c){h(a,b,c,d)},{maxTries:c.maxTries,pollIntervalMs:c.pollIntervalMs})}})}function h(a,c,d,e){return a?c(a,e):(q.log.info("received completed transaction:",d),void i(d.receipt,function(a){return a?c(a,e):void b(e.productId,function(a,b){return a?c(a,b):void c(null,b)},{fetchStubs:q.fakeProducts})}))}function i(a,b){return q.hasAddReceipt?(q.log.info("adding receipt to device with addReceipt"),j(a,b)):(q.log.info("adding receipt to device with localStorage"),k(a,b))}function j(a,b){var c=q.appSelf.addReceipt(a);c.onsuccess=function(){q.log.info("item fully purchased and receipt installed"),b(null)},c.onerror=function(){var a=this.error.name;q.log.error("error calling app.addReceipt",a),b(a)}}function k(a,b){var c=q.localStorage.getItem(q.localStorageKey);c=c?JSON.parse(c):[],-1===c.indexOf(a)?c.push(a):q.log.info("not adding receipt",a.substring(0,5),"because it has already been added"),q.localStorage.setItem(q.localStorageKey,JSON.stringify(c)),b(null)}function l(a,b,c,d){d=d||{},d.maxTries=d.maxTries||10,d.pollIntervalMs=d.pollIntervalMs||1e3,d._tries=d._tries||1;var e=q.log;return e.debug("Getting transaction state at",b,"tries=",d._tries),d._tries>d.maxTries?(e.error("Giving up on transaction at",b,"after",d._tries,"tries"),c("TRANSACTION_TIMEOUT")):void a.get(b,function(f,g){return f?c(f):"complete"===g.status?c(null,g):"incomplete"!==g.status?(e.error("transaction status",g.status,"from",b,"was unexpected"),c("INVALID_TRANSACTION_STATE")):(e.debug("Re-trying incomplete transaction in",d.pollIntervalMs,"ms"),void window.setTimeout(function(){l(a,b,c,{maxTries:d.maxTries,pollIntervalMs:d.pollIntervalMs,_tries:d._tries+1})},d.pollIntervalMs))})}function m(a){return{productId:a.guid,name:a.name,smallImageUrl:a.logo_url}}function n(a,b){b=b||{},this.baseUrl=a,this.log=q.log,this.timeoutMs=q.apiTimeoutMs||1e4,this.versionPrefix=q.apiVersionPrefix||void 0}function o(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")}var p={version:"0.0.4"};a.__version__=p.version;var q,r={allowAnyAppReceipt:!1,apiUrlBase:"https://marketplace.firefox.com",apiVersionPrefix:"/api/v1",apiTimeoutMs:null,fakeProducts:!1,log:window.console||{debug:function(){},error:function(){},info:function(){},log:function(){},warn:function(){}},receiptCheckSites:["https://receiptcheck.marketplace.firefox.com","https://marketplace.firefox.com"],appSelf:null,hasAddReceipt:null,onerror:function(a){throw a},oninit:function(){q.log.info("fxpay version:",a.__version__),q.log.info("initialization ran successfully")},onrestore:function(a,b){a?q.log.error("error while restoring product:",b.productId,"message:",a):q.log.info("product",b.productId,"was restored from receipt")},initError:"NOT_INITIALIZED",localStorage:window.localStorage||null,localStorageKey:"fxpayReceipts",mozPay:navigator.mozPay||null,mozApps:navigator.mozApps||null};a.configure=function(a,b){if(b=b||{},b.reset){q={};for(var c in r)q[c]=r[c]}for(var d in a){if("undefined"==typeof q[d])return q.log.error("configure() received an unknown setting:",d),q.onerror("INCORRECT_USAGE");q[d]=a[d]}return q},a.configure({},{reset:!0}),a.init=function(b){function c(a){return q.initError=a,q.onerror(q.initError)}if(b=b||{},a.configure(b),!q.mozApps||!q.mozApps.getSelf)return q.log.error("Missing pay platform: mozApps was falsey"),c("PAY_PLATFORM_UNAVAILABLE");var d=q.mozApps.getSelf();d.onsuccess=function(){if(q.appSelf=this.result,!q.appSelf)return q.log.error("falsey app object from getSelf()",q.appSelf),c("NOT_INSTALLED_AS_APP");var b=q.appSelf.manifest.permissions;if(!b||!b.systemXHR)return q.log.error("incorrect manifest permissions",q.appSelf.manifest),c("MISSING_XHR_PERMISSION");if(q.hasAddReceipt=!!q.appSelf.addReceipt,!q.hasAddReceipt&&!q.localStorage)return q.log.error("no way to store receipts on this platform"),c("PAY_PLATFORM_UNAVAILABLE");for(var d,e=0,f=a.getReceipts(),g=0;g<f.length;g++)d=f[g],q.log.info("Installed receipt: "+d),e++,a.verifyReceipt(d,q.onrestore);q.log.info("Number of receipts installed: "+e),q.initError=null,q.oninit()},d.onerror=function(){var a=this.error.name;q.log.error("mozApps.getSelf() returned an error",a),c(a)}},a.purchase=function(a,b,c){c=c||{},c.maxTries=c.maxTries||void 0,c.pollIntervalMs=c.pollIntervalMs||void 0;var d={};return b||(b=function(a,b){if(a)throw a;console.log("product",b.productId,"purchased")}),q.initError?(q.log.error("init failed:",q.initError),b(q.initError,d)):q.mozPay?void g(a,b,c):(q.log.error("Missing pay platform: mozPay was falsey"),b("PAY_PLATFORM_UNAVAILABLE",d))},a.getReceipts=function(){var a=0,b=[];q.appSelf&&q.appSelf.receipts&&(a=q.appSelf.receipts.length,b=Array.prototype.slice.call(q.appSelf.receipts));var c=0,d=q.localStorage.getItem(q.localStorageKey);if(d){d=JSON.parse(d);for(var e=0;e<d.length;e++)-1===b.indexOf(d[e])?(b.push(d[e]),c++):q.log.info("ignoring dupe receipt fetched from local storage",d[e].substring(0,5))}return q.log.info("receipts fetched from mozApps:",a),q.log.info("receipts fetched from localStorage:",c),b},a.getProducts=function(a){var b=[];if(q.initError)return q.log.error("init failed:",q.initError),a(q.initError,b);var c,d=new n(q.apiUrlBase),e=encodeURIComponent(q.appSelf.origin);q.fakeProducts?(q.log.warn("about to fetch fake products"),c="/payments/stub-in-app-products/"):(q.log.info("about to fetch real products for app",e),c="/payments/"+e+"/in-app/?active=1"),d.get(c,function(c,d){if(c)return a(c,b);q.log.info("total products fetched:",d.objects.length);for(var e=0;e<d.objects.length;e++){var f=d.objects[e],g=m(f);b.push(g)}a(c,b)})},a.verifyReceipt=function(c,d){a.verifyReceiptData(c,function(a,e,f){if(a)return d(a,f);var g=e.iss;q.log.info("derived base API URL from receipt:",g);var h=new n(g);q.log.info("about to post to verifier URL",e.verify),h.post(e.verify,c,function(a,g){return a?(q.log.error("Error verifying receipt:",a),d(a,f)):(q.log.info("verification result:",g),"ok"!==g.status?(q.log.error("receipt",c.substring(0,10),"is invalid; service returned:",g.status,g.reason),d("INVALID_RECEIPT",f)):(q.log.info("validated receipt for",f),void b(f.productId,function(a,b){return a?d(a,f):d(null,b)},{fetchStubs:"test-receipt"===e.typ,api:h})))},{contentType:"text/plain"})})},a.verifyReceiptData=function(a,b){c(a,function(a,c){return a?b(a,c,{}):void d(c,function(a,d){return a?b(a,c,d):void e(c,function(a){return a?b(a,c,d):void b(null,c,d)})})})},a.API=n,n.prototype.url=function(a,b){b=b||{},b.versioned="undefined"!=typeof b.versioned?b.versioned:!0;var c=this.baseUrl;return b.versioned&&(c+=this.versionPrefix||""),c+=a},n.prototype.request=function(b,c,d,e,f){f=f||{};var g=d?"application/x-www-form-urlencoded":null;f.contentType=f.contentType||g;var h={Accept:"application/json"};f.contentType&&(h["Content-Type"]=f.contentType),f.headers=f.headers||{};for(var i in h)i in f.headers||(f.headers[i]=h[i]);f.headers["x-fxpay-version"]=a.__version__;var j,k=this.log,l=this;e||(e=function(a,b){if(a)throw a;k.info("default callback received data:",b)}),j=/^http(s)?:\/\/.*/.test(c)?c:this.url(c);var m=new XMLHttpRequest({mozSystem:!0}),n={abort:function(){k.error("xhr abort: path:",c),e("API_REQUEST_ABORTED")},error:function(a){k.error("xhr error: ",a,"path:",c),e("API_REQUEST_ERROR")},load:function(){var a;if("2"!==this.status.toString().slice(0,1)){var b="BAD_API_RESPONSE";return k.error(b,"status:",this.status,"for URL:",j),k.debug(b,"response:",this.responseText),e("BAD_API_RESPONSE")}k.debug("xhr load: GOT",this.responseText);try{a=JSON.parse(this.responseText)}catch(c){var b="BAD_JSON_RESPONSE";return k.error(b,"for URL:",j,"exception",c,"response:",this.responseText),e(b)}e(null,a)},timeout:function(){k.error("xhr request to",j,"timed out after",l.timeoutMs,"ms"),e("API_REQUEST_TIMEOUT")}};for(var p in n)m.addEventListener(p,n[p],!1);k.debug("opening",b,"to",j),m.timeout=l.timeoutMs,m.open(b,j,!0);for(var q in f.headers)m.setRequestHeader(q,f.headers[q]);"application/x-www-form-urlencoded"===f.contentType&&d&&(d=o(d)),m.send(d)},n.prototype.get=function(a,b,c){this.request("GET",a,null,b,c)},n.prototype.del=function(a,b,c){this.request("DELETE",a,null,b,c)},n.prototype.post=function(a,b,c,d){this.request("POST",a,b,c,d)},n.prototype.put=function(a,b,c,d){this.request("PUT",a,b,c,d)}}("undefined"==typeof exports?this.fxpay={}:exports);